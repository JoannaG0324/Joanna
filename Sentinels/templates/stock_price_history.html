<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Price History</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>
    <style>
        /* 全局样式 */
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.4;
            color: #333;
            background-color: #f8f8f8;
            margin: 0;
            padding: 0;
        }

        /* 导航栏样式 */
        nav {
            background-color: #2c3e50;
            padding: 10px 0;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        nav a {
            margin: 0 15px;
            text-decoration: none;
            color: #ecf0f1;
            font-weight: bold;
            transition: color 0.2s ease;
        }
        nav a:hover {
            color: #3498db;
        }

        /* 表格容器样式 */
        .table-container {
            width: 98%;
            max-height: 70vh;
            overflow-y: auto;
            margin: 15px auto;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.08);
            border-radius: 6px;
        }

        /* 表格样式 */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
        }
        th {
            background-color: #f0f0f0;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        tr:hover {
            background-color: #f5f5f5;
            cursor: pointer;
        }

        /* 分页样式 */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination a {
            color: #3498db;
            padding: 8px 14px;
            text-decoration: none;
            border: 1px solid #3498db;
            margin: 0 3px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        .pagination a.active {
            background-color: #3498db;
            color: #fff;
        }
        .pagination a:hover:not(.active) {
            background-color: #e8f4fc;
        }

        /* 搜索容器样式 */
        .search-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin: 15px auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.08);
            max-width: 98%;
        }
        .search-container select,
        .search-container input[type="text"] {
            padding: 8px 12px;
            width: 200px;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .search-container select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M10.293 3.293L6 7.586 1.707 3.293A1 1 0 00.293 4.707l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 10px;
            padding-right: 25px;
            appearance: none;
        }
        .search-container select:focus,
        .search-container input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52,152,219,0.15);
        }
        .search-container button {
            padding: 8px 15px;
            border: none;
            background-color: #3498db;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }
        .search-container button:hover {
            background-color: #2980b9;
        }

        /* 图表容器样式 */
        .chart-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 98%;
            height: 400px;
            box-sizing: border-box;
            overflow: hidden;
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(0,0,0,0.08);
            margin: 15px auto;
        }

        #chart {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        #stock-name {
            text-align: center;
            width: 100%;
            margin: 0;
            padding: 12px;
            font-size: 18px;
            font-weight: bold;
            background-color: #f8f9fa;
            color: #2c3e50;
            border-bottom: 1px solid #e0e0e0;
        }
    </style>
</head>
<body>
    <nav>
        <a href="{{ url_for('index') }}">Market</a>
        <a href="{{ url_for('stock_price_history') }}">Stock</a>
    </nav>
    
    <div class="search-container">       
        <form id="search-form" method="get" action="/stock_price_history">
                <select name="index">
                    <option value="">All Stock</option>
                    <option value="csindex_800" {% if request.args.get('index') == 'csindex_800' %}selected{% endif %}>csindex 800</option>
                </select>

                <input type="text" name="stock_name" placeholder="Stock Name" value="{{ request.args.get('stock_name', '') }}">

                <button type="submit">Search</button>
                <button type="button" onclick="clearForm()">Clear</button> <!-- 清空条件按钮 -->
            </form>
    </div>

        <!-- 筛选条件 -->
    <div class="search-container">
        <select id="industry-level-1" onchange="updateLevel2()">
            <option value="">Select Level 1 Industry</option>
        </select>
        <select id="industry-level-2" onchange="updateLevel3()">
            <option value="">Select Level 2 Industry</option>
        </select>
        <select id="industry-level-3" onchange="updateLevel4()">
            <option value="">Select Level 3 Industry</option>
        </select>
        <select id="industry-level-4">
            <option value="">Select Level 4 Industry</option>
        </select>
    </div>

    
    <div class="table-container">
        <table id="stock-table">
            <thead>
                <tr>
                    <th onclick="sortTable('date')">日期</th>
                    <th>一级行业</th>
                    <th>二级行业</th>
                    <th>三级行业</th>
                    <th>四级行业</th>
                    <th>代码</th>
                    <th>名称</th>
                    <th onclick="sortTable('open')">open</th>
                    <th onclick="sortTable('close')">close</th>
                    <th onclick="sortTable('price_change_percentage')">涨跌</th>
                    <th onclick="sortTable('20_day_ma')">MA_20</th>
                    <th onclick="sortTable('ATR')">ATR</th>
                    <th onclick="sortTable('eps')">EPS</th>
                    <th onclick="sortTable('pe')">PE</th>
                    <th onclick="sortTable('net_assets_per_share')">NAV</th>
                    <th onclick="sortTable('pb')">PB</th>
                    <th onclick="sortTable('roe')">ROE</th>
                    <th onclick="sortTable('operating_cash_flow_per_share')">Cash Flow</th>
                    <th onclick="sortTable('gross_profit_margin')">Gross Profit</th> 
                    <th onclick="sortTable('latest_announcement_date')">Report Date</th> 
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- 数据通过 JavaScript 渲染 -->
            </tbody>
        </table>
    </div>
        <!-- Bootstrap Modal -->
    <div class="modal fade" id="stockModal" tabindex="-1" role="dialog" aria-labelledby="stockModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document"> <!-- 使用 modal-lg 类 -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stockModalLabel">Stock Chart</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="stock-name"></div>
                    <div class="chart-container">
                        <div id="chart"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 点击表格行时显示模态框
        function showStockChart(stockCode, stockName) {
            $('#stockModalLabel').text('Stock Chart for ' + stockName);
            window.currentStockCode = stockCode;  // 储存 stockCode
            $('#stockModal').modal('show');  // 显示模态框
        }

        // 处理模态框显示后的图表渲染
        $('#stockModal').on('shown.bs.modal', function () {
            var chartDom = document.getElementById('chart');
            var myChart = echarts.init(chartDom);

            // 使用全局变量获取当前 stockCode
            $.ajax({
                url: '/get_stock_history',
                method: 'GET',
                data: { stock_code: window.currentStockCode },
                success: function (data) {
                    var option = createChartOption(data);  // 确保 createChartOption 函数已定义
                    myChart.setOption(option);

                    // 添加显示最近5个数据的按钮
                    myChart.setOption({
                        toolbox: {
                            feature: {
                                myTool_5d: {
                                    show: true,
                                    title: '5D',
                                    icon: 'path://M344.615 435.956l-65.544 58.338-28.899-32.213c-15.182-15.336-22.657-30.71-24.121-47.549-0.54-6.165-1.195-13.833-0.463-23.08l33.37-373.033 111.782 119.72-26.125 297.817zM627.829 901.16l64.541 70.63-31.25 29.169c-18.34 18.418-34.833 23.042-70.128 23.042H293.174l-57.413-59.88 68.164-62.961h323.904zM395.478 122.84L281.884 0h449.79l57.798 64.503-68.549 58.338H395.478z m239.094 328.49c36.837 0 41.73 3.044 68.819 32.29l27.127 29.169-72.942 61.344H408.887c-47.587 0-58.762-4.586-84.078-30.71l-27.127-29.17 71.247-62.962h265.643z m44.312 138.177l68.434-59.88 30.325 30.711c11.83 12.253 19.536 30.71 20.769 44.505 0.655 7.668 0.192 19.96-0.116 33.793L779.57 845.864c-2.928 36.838-11.79 58.377-26.048 70.63l-42.694 38.379-57.837-64.504 25.894-300.86z', // 自定义图标
                                    onclick: function () {
                                        myChart.dispatchAction({
                                            type: 'dataZoom',
                                            start: Math.max(0, 100 - (5 / data.length) * 100),
                                            end: 100
                                        });
                                    }
                                },  // 5D
                                myTool_20d: {
                                    show: true,
                                    title: '20D',
                                    icon: 'path://M613.449865 887.558615l-57.825401 68.910306-17.419136-24.519604c-8.786192-13.792278-14.200938-27.584556-15.120423-41.376834-0.306495-4.597426 0.40866-10.727327 0.153247-15.27367l20.177592-300.262995 48.170807-59.766537 42.347401 59.766537-20.484087 312.522797z m28.452959-434.967574l-50.265191 62.831487-40.3041-62.831487 16.755063-266.497456c2.196548-18.389704 2.656291-29.117031 3.371446-35.246932 1.379228-13.741195 6.334231-24.519605 15.835578-35.19585l30.445176-36.728325 43.930959 67.377831-19.768931 306.290732z m208.978549 448.810934l48.885962 73.507733-25.183677 30.700588c-10.420832 13.741195-22.57847 18.389704-44.084207 18.389704h-199.22179c-21.505737 0-34.327447-6.129901-43.062556-18.389704l-20.126509-30.700588 60.890352-73.507733h221.902425zM678.426818 124.845655l-47.251322-65.845356 21.812232-30.700588c13.536865-18.389704 26.613988-26.05208 43.573381-26.052081h207.139579c15.835578 0 31.262496 10.727327 41.325751 26.052081l17.725631 29.11703-59.051382 67.377831h-225.27387z m211.379428 450.241245l50.316272-61.24793 40.201936 61.24793-16.806146 265.016063c-0.970568 19.922179-2.45196 32.181981-2.145466 36.779408-1.379228 13.741195-6.436396 22.936047-16.959393 35.195849l-32.794971 35.19585-41.325751-61.24793 19.513519-310.93924z m28.861618-428.837673l58.898134-68.910307 13.84336 21.454655c10.063255 15.324753 15.478001 29.117031 16.448569 44.390701 0.40866 6.129901 0.81732 12.259802 0.051082 18.389704l-18.542951 291.017061-51.49117 61.299012-39.078121-61.299012 19.871097-306.341814zM119.890652 883.727427l-97.05677 118.000599 23.80445-364.524793c0.561908-9.194852 1.123815-18.389704 2.86062-26.052081 1.787888-7.662377 3.626858-13.741195 6.691809-18.389703 0 0 6.283149-7.662377 16.601816-21.454655l30.087599-39.793275 37.188067 53.585553L119.890652 883.727427z m254.135488 15.375835l41.121421 61.299013-48.937045 61.299012H35.298015l101.296617-122.546942 237.431508-0.051083z m24.928265-347.718647c-12.41305 16.857228-22.271974 21.454654-48.119725 21.454655H157.283049l-40.968173-59.766537 32.028734-44.390702c4.137683-6.129901 9.450264-10.727327 14.86501-13.792277 5.414746-3.013868 9.807842-4.597426 15.426918-4.597426h212.707573l40.968173 59.766537-33.356879 41.32575zM173.322957 122.546942l-40.968173-59.766537L180.065849 0h229.564801c22.476304 0 33.152549 7.662377 45.667764 27.584556l15.06934 24.519604-57.365659 70.442782H173.322957z m251.12162 19.871097l58.489475-70.442782 19.973261 30.649506c2.45196 3.064951 5.210416 10.727327 8.122119 21.454654 1.43031 4.597426 1.736805 9.245934 1.992218 13.792278 0.40866 6.129901-0.051083 16.857228-0.306495 30.649506l-15.835578 226.653098c-1.63464 27.584556-5.414746 38.311883-19.871097 58.182979l-31.211413 39.844358-40.866008-58.182979 19.513519-292.600618z', // 自定义图标
                                    onclick: function () {
                                        myChart.dispatchAction({
                                            type: 'dataZoom',
                                            start: Math.max(0, 100 - (20 / data.length) * 100),
                                            end: 100
                                        });
                                    }
                                } //20D
                            }
                        }
                    });
                },
                error: function (error) {
                    console.error('Error fetching stock history:', error);
                }
            });
        });

        // 创建K线图表的配置
        function createChartOption(rawData) {
            const upColor = '#00da3c';
            const downColor = '#ec0000';
            function splitData(rawData) {
                let categoryData = [];
                let values = [];
                for (let i = 0; i < rawData.length; i++) {
                    // 因为后端已经格式化日期，所以直接使用
                    categoryData.push(rawData[i].date);  
                    values.push([rawData[i].open, rawData[i].close, rawData[i].low, rawData[i].high, rawData[i].volume]);
                }
                return {
                    categoryData: categoryData,
                    values: values,
                };
            }
            // 计算MA
        function calculateMA(dayCount, data) {
            var result = [];
            for (var i = 0, len = data.values.length; i < len; i++) {
                if (i < dayCount) {
                    result.push('-');
                    continue;
                }
                var sum = 0;
                for (var j = 0; j < dayCount; j++) {
                    sum += data.values[i - j][1];
                }
                result.push((sum / dayCount).toFixed(2));
            }
            return result;
        }

            var data = splitData(rawData);

            return {
                animation: false,
            legend: {
                top: 10,
                left: 'center',
                data: ['Stock Price', 'MA5', 'MA10', 'MA20', 'MA30']
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
            },
            xAxis: {
                type: 'category',
                data: data.categoryData,
                boundaryGap: false,
                axisLine: { onZero: false },
                splitLine: { show: false },
                min: 'dataMin',
                max: 'dataMax'
            },
            yAxis: {
                scale: true,
                splitArea: {
                    show: true
                }
            },
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    xAxisIndex: [0],
                    start: 0, // Initial start value (percentage)
                    end: 100, // Initial end value (percentage)
                    handleSize: '100%', // Handle size
                    handleStyle: {
                        color: '#aaa' // Handle color
                    },
                    textStyle: {
                        color: '#333' // Text color
                    },
                    borderColor: '#ddd', // Border color
                },
                {
                    type: 'inside',
                    xAxisIndex: [0],
                    start: 0, // Initial start value (percentage)
                    end: 100  // Initial end value (percentage)
                }
            ],
            series: [
                {
                    name: 'Stock Price',
                    type: 'candlestick',
                    data: data.values,
                    itemStyle: {
                        color: downColor, //upColor
                        color0: upColor, //downColor
                        borderColor: undefined,
                        borderColor0: undefined
                    }
                },
                {
                    name: 'MA5',
                    type: 'line',
                    data: calculateMA(5, data),
                    smooth: true,
                    lineStyle: {
                        opacity: 0.5
                    }
                },
                {
                    name: 'MA10',
                    type: 'line',
                    data: calculateMA(10, data),
                    smooth: true,
                    lineStyle: {
                        opacity: 0.5
                    }
                },
                {
                    name: 'MA20',
                    type: 'line',
                    data: calculateMA(20, data),
                    smooth: true,
                    lineStyle: {
                        opacity: 0.5
                    }
                },
                {
                    name: 'MA30',
                    type: 'line',
                    data: calculateMA(30, data),
                    smooth: true,
                    lineStyle: {
                        opacity: 0.5
                    }
                }
            ]
        };
    }
        //
        let data = []; // 存储所有的表格数据
        let filteredData = []; // 存储筛选后的表格数据
        let currentSort = { column: 'date', ascending: true }; // 默认按日期升序排序
        
// 排序功能
function sortTable(column) {
    // 切换排序顺序
    if (currentSort.column === column) {
        currentSort.ascending = !currentSort.ascending;
    } else {
        currentSort.column = column;
        currentSort.ascending = true;
    }

    const sortedData = [...filteredData].sort((a, b) => {
        if (a[column] === b[column]) return 0; // 处理相等的情况
        if (typeof a[column] === 'string') {
            return (a[column].localeCompare(b[column])) * (currentSort.ascending ? 1 : -1);
        } else {
            return (a[column] - b[column]) * (currentSort.ascending ? 1 : -1);
        }
    });

    // 更新表格内容
    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = '';

    sortedData.forEach(row => {
        const tr = document.createElement('tr');
        tr.onclick = () => showStockChart(row.stock_code, row.stock_name);
        tr.innerHTML = generateTableRowHTML(row);
        // 生成表格行HTML
        function generateTableRowHTML(row) {
            return `
                <td>${row.date}</td>
                <td>${row.industry_level_1_name}</td>
                <td>${row.industry_level_2_name}</td>
                <td>${row.industry_level_3_name}</td>
                <td>${row.industry_level_4_name}</td>
                <td>${row.stock_code}</td>
                <td>${row.stock_name}</td>
                <td style="text-align: right;">${row.open.toFixed(2)}</td>
                <td style="text-align: right;">${row.close.toFixed(2)}</td>
                <td style="background-color: ${row.price_change_percentage > 0 ? `rgba(255, 0, 0, ${row.price_change_percentage / 10})` : row.price_change_percentage < 0 ? `rgba(0, 128, 0, ${-row.price_change_percentage / 20})` : 'white'}; text-align: right;">
                    ${row.price_change_percentage.toFixed(2)}%
                </td>
                <td style="text-align: right;">${row['20_day_ma'].toFixed(2)}</td>
                <td style="text-align: right;">${row.ATR.toFixed(2)}</td>
                <td style="text-align: right;">${parseFloat(row.eps).toFixed(2)}</td>
                <td style="text-align: right;">${parseFloat(row.pe).toFixed(2)}</td>
                <td style="text-align: right;">${parseFloat(row.net_assets_per_share).toFixed(2)}</td>
                <td style="text-align: right;">${parseFloat(row.pb).toFixed(2)}</td>
                <td style="text-align: right;">${parseFloat(row.roe).toFixed(2)}%</td>
                <td style="text-align: right;">${parseFloat(row.operating_cash_flow_per_share).toFixed(2)}</td>
                <td style="text-align: right;">${parseFloat(row.gross_profit_margin).toFixed(2)}%</td>
                <td style="text-align: right;">${row.latest_announcement_date}</td>
            `;
        }
        tableBody.appendChild(tr);
    });
}  
        // ///////////
let filters = {
    level1: [],
    level2: [],
    level3: [],
    level4: []
}; // 存储行业层级数据

function loadData() {
    data = [
        // 从后端获取的数据数组
        {% for row in stock_prices %}
        {
            date: '{{ row['date'] }}',
            industry_level_1_name: '{{ row['industry_level_1_name'] }}',
            industry_level_2_name: '{{ row['industry_level_2_name'] }}',
            industry_level_3_name: '{{ row['industry_level_3_name'] }}',
            industry_level_4_name: '{{ row['industry_level_4_name'] }}',
            stock_code: '{{ row['stock_code'] }}',
            stock_name: '{{ row['stock_name'] }}',
            open: {{ row['open'] }},
            close: {{ row['close'] }},
            price_change_percentage: {{ row['price_change_percentage'] }},
            '20_day_ma': {{ row['20_day_ma'] }},
            ATR: {{ row['ATR'] }},
            eps: {{ row['eps'] }},
            pe: {{ row['pe'] }},
            net_assets_per_share: {{ row['net_assets_per_share'] }},
            roe: {{ row['roe'] }},
            pb: {{ row['pb'] }},
            operating_cash_flow_per_share: {{ row['operating_cash_flow_per_share'] }},
            gross_profit_margin: {{ row['gross_profit_margin'] }},
            latest_announcement_date: '{{ row['latest_announcement_date'] }}'
        },
        {% endfor %}
    ];

//     console.log('Data loaded:', data); // 调试信息
    populateFilters(); // 填充筛选下拉菜单
    filterData(); // 默认加载所有数据
}

function populateFilters() {
    const level1Select = document.getElementById('industry-level-1');
    const level2Select = document.getElementById('industry-level-2');
    const level3Select = document.getElementById('industry-level-3');
    const level4Select = document.getElementById('industry-level-4');

    // 从数据中提取唯一的行业层级
    filters.level1 = [...new Set(data.map(item => item.industry_level_1_name))];
    filters.level2 = [...new Set(data.map(item => item.industry_level_2_name))];
    filters.level3 = [...new Set(data.map(item => item.industry_level_3_name))];
    filters.level4 = [...new Set(data.map(item => item.industry_level_4_name))];

    // 填充 Level 1 下拉菜单
    level1Select.innerHTML = '<option value="">Select Level 1 Industry</option>';
    filters.level1.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        level1Select.appendChild(optionElement);
    });

    // 清空下级层级选项
    level2Select.innerHTML = '<option value="">Select Level 2 Industry</option>';
    level3Select.innerHTML = '<option value="">Select Level 3 Industry</option>';
    level4Select.innerHTML = '<option value="">Select Level 4 Industry</option>';
}

function updateLevel2() {
    const level1Select = document.getElementById('industry-level-1');
    const level2Select = document.getElementById('industry-level-2');
    const selectedLevel1 = level1Select.value;

    if (selectedLevel1) {
        // 根据 Level 1 筛选 Level 2 选项
        const level2Options = [...new Set(data.filter(item => item.industry_level_1_name === selectedLevel1)
                                         .map(item => item.industry_level_2_name))];

        level2Select.innerHTML = '<option value="">Select Level 2 Industry</option>';
        level2Options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            level2Select.appendChild(optionElement);
        });
    } else {
        level2Select.innerHTML = '<option value="">Select Level 2 Industry</option>';
    }

    // 清空 Level 3 和 Level 4 选项
    updateLevel3();
}

function updateLevel3() {
    const level2Select = document.getElementById('industry-level-2');
    const level3Select = document.getElementById('industry-level-3');
    const selectedLevel2 = level2Select.value;

    if (selectedLevel2) {
        // 根据 Level 2 筛选 Level 3 选项
        const level3Options = [...new Set(data.filter(item => item.industry_level_2_name === selectedLevel2)
                                         .map(item => item.industry_level_3_name))];

        level3Select.innerHTML = '<option value="">Select Level 3 Industry</option>';
        level3Options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            level3Select.appendChild(optionElement);
        });
    } else {
        level3Select.innerHTML = '<option value="">Select Level 3 Industry</option>';
    }

    // 清空 Level 4 选项
    updateLevel4();
}
// 更新第四级行业
function updateLevel4() {
    const level3Select = document.getElementById('industry-level-3');
    const level4Select = document.getElementById('industry-level-4');
    const selectedLevel3 = level3Select.value;

    console.log('Selected Level 3:', selectedLevel3); // 调试信息

    if (selectedLevel3) {
        // 根据选中的第三级行业来过滤第四级行业
        const level4Options = [...new Set(data
            .filter(item => item.industry_level_3_name === selectedLevel3) // 仅过滤出符合第三级行业的数据
            .map(item => item.industry_level_4_name))]; // 提取出第四级行业的选项

        console.log('Level 4 Options after filtering:', level4Options); // 调试信息

        // 清空并填充第四级菜单
        level4Select.innerHTML = '<option value="">Select Level 4 Industry</option>';
        level4Options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            level4Select.appendChild(optionElement);
        });
    } else {
        // 如果没有选择第三级行业，清空第四级菜单
        level4Select.innerHTML = '<option value="">Select Level 4 Industry</option>';
    }

    filterData(); // 重新过滤数据
}

// 在筛选时使用 filteredData 而不是 data
function filterData() {
    // 假设你有一系列筛选条件
    const selectedLevel1 = document.getElementById('industry-level-1').value;
    const selectedLevel2 = document.getElementById('industry-level-2').value;
    const selectedLevel3 = document.getElementById('industry-level-3').value;
    const selectedLevel4 = document.getElementById('industry-level-4').value;

    filteredData = data;

    if (selectedLevel1) {
        filteredData = filteredData.filter(item => item.industry_level_1_name === selectedLevel1);
    }

    if (selectedLevel2) {
        filteredData = filteredData.filter(item => item.industry_level_2_name === selectedLevel2);
    }

    if (selectedLevel3) {
        filteredData = filteredData.filter(item => item.industry_level_3_name === selectedLevel3);
    }

    if (selectedLevel4) {
        filteredData = filteredData.filter(item => item.industry_level_4_name === selectedLevel4);
    }

    // 更新表格内容
    sortTable(currentSort.column);  // 按照当前的排序规则更新表格
}
        
// 页面加载时初始化数据
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    filteredData = [...data];  // 初始化时将所有数据赋值给 filteredData
    filterData();  // 初始化筛选数据
});
        
// 清空表单并提交
function clearForm() {
    const form = document.getElementById('search-form');
    
    // 清空选择框
    form.querySelector('select[name="index"]').value = '';
    
    // 清空输入框
    form.querySelector('input[name="stock_name"]').value = '';

    // 提交表单
    form.submit();
}
    </script>

</body>
</html>
